importScripts("aes.js");importScripts("dext5upload.base64.js");importScripts("dext5upload.xhr.js");var numberOfServerUploadedChunks=0;
function buildFormData(c,h,f,d,e,m,g,l,q,t,r,k){var n=new FileReaderSync,b=n.readAsDataURL(c).match(/,(.*)$/)[1],u,p=function(){var a="";if("0"!=e.encryptParam){var c;c=""+("d01"+Dext5Base64._trans_unitAttributeDelimiter+"uploadRequest"+Dext5Base64._trans_unitDelimiter);c+="d18"+Dext5Base64._trans_unitAttributeDelimiter+h+Dext5Base64._trans_unitDelimiter;c+="d07"+Dext5Base64._trans_unitAttributeDelimiter+f+Dext5Base64._trans_unitDelimiter;c+="d08"+Dext5Base64._trans_unitAttributeDelimiter+d+Dext5Base64._trans_unitDelimiter;
c+="d12"+Dext5Base64._trans_unitAttributeDelimiter+q+Dext5Base64._trans_unitDelimiter;c+="d38"+Dext5Base64._trans_unitAttributeDelimiter+t+Dext5Base64._trans_unitDelimiter;c+="d11"+Dext5Base64._trans_unitAttributeDelimiter+e.folderNameRule+Dext5Base64._trans_unitDelimiter;c+="d09"+Dext5Base64._trans_unitAttributeDelimiter+e.fileNameRule+Dext5Base64._trans_unitDelimiter;c+="d10"+Dext5Base64._trans_unitAttributeDelimiter+e.fileNameRuleEx+Dext5Base64._trans_unitDelimiter;c+="d35"+Dext5Base64._trans_unitAttributeDelimiter+
e.checkFileExtension+Dext5Base64._trans_unitDelimiter;c+="d37"+Dext5Base64._trans_unitAttributeDelimiter+e.uploadChunkSize+Dext5Base64._trans_unitDelimiter;c+="d47"+Dext5Base64._trans_unitAttributeDelimiter+g+Dext5Base64._trans_unitDelimiter;0<e.encryptFile&&(c+="d17"+Dext5Base64._trans_unitAttributeDelimiter+e.encryptFile+Dext5Base64._trans_unitDelimiter);c=Dext5Base64.makeEncryptParamFinal(e.encryptParam,c);a+="--"+m+'\r\nContent-Disposition: form-data; name="'+c.name+'"';a+="\r\n\r\n";a+=c.value;
a+="\r\n"}else a+="--"+m+'\r\nContent-Disposition: form-data; name="dext5CMD"',a+="\r\n",a+="\r\n",a+="uploadRequest",a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="chunkNumber"',a+="\r\n",a+="\r\n",a+=h,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="GUID"',a+="\r\n",a+="\r\n",a+=f,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="fileName"',a+="\r\n",a+="\r\n",a+=d,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="gpid"',a+="\r\n",a+="\r\n",
a+=q,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="fidx"',a+="\r\n",a+="\r\n",a+=t,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="folderNameRule"',a+="\r\n",a+="\r\n",a+=e.folderNameRule,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="fileNameRule"',a+="\r\n",a+="\r\n",a+=e.fileNameRule,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="fileNameRuleEx"',a+="\r\n",a+="\r\n",a+=e.fileNameRuleEx,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="cfe"',
a+="\r\n",a+="\r\n",a+=e.checkFileExtension,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="cs"',a+="\r\n",a+="\r\n",a+=e.uploadChunkSize,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="fs"',a+="\r\n",a+="\r\n",a+=g,a+="\r\n",0<e.encryptFile&&(a+="--"+m+'\r\nContent-Disposition: form-data; name="fde"',a+="\r\n",a+="\r\n",a+=e.encryptFile,a+="\r\n");a+="--"+m+'\r\nContent-Disposition: form-data; name="mark"';a+="\r\n";a+="\r\n";a+=l;a+="\r\n";c=r.length;for(var u=0;u<
c;u++)a+="--"+m+'\r\nContent-Disposition: form-data; name="'+r[u].form_name+'"',a+="\r\n",a+="\r\n",a+=encodeURIComponent(r[u].form_value),a+="\r\n";a+="--"+m+'\r\nContent-Disposition: form-data; name="Slice"; filename="blob"';a+="\r\n";a+="Content-Type: application/octet-stream; charset=UTF-8";a+="\r\n";a+="\r\n";a+=b+"\r\n";a+="--"+m+"--\r\n";n=null;k(a)},w=function(a){b=n.readAsDataURL(a).match(/,(.*)$/)[1];p()};0<e.encryptFile?(u||(u=n.readAsArrayBuffer(c)),encryptFileData(u,e.ServerReleaseVer.substring(0,
11),16*e.encryptFile,w)):p()}function makeGuidTagName(c){var h=0,f=(new Date).getTime().toString(32),d;for(d=0;5>d;d++)f+=Math.floor(65535*Math.random()).toString(32);return(c||"o_")+f+(h++).toString(32)}
function upload_merge(c,h,f,d,e,m,g,l,q,t,r){var k=XHRFactory.getInstance();k.open("POST",e,m);k.onreadystatechange=function(b){if(4==k.readyState)if(200==k.status){var d=k.responseText;b=d.split("|");1==b.length&&(b=Dext5Base64.makeDecryptReponseMessageEx2(d),d="success"==b.result?b.value:"error"==b.result?b.value:""==g.ServerReleaseVer||"2.7.1120889.1613.01">=g.ServerReleaseVer?Dext5Base64.decode(d):Dext5Base64.makeDecryptReponseMessage(d),b=d.split("|"));if(0==d.indexOf("error"))self.postMessage({type:"error",
code:b[1],message:b[2],id:c}),XHRFactory.release(k),self.close();else{var e;e=b[0];var f=e.indexOf("::");-1<f?(d=e.substring(0,f),e=e.substring(f+2)):(d=h,e=b[0]);2==b.length?-1<b[1].indexOf("\b")?self.postMessage({type:"complete",id:c,originalFileName:d,uploadFilePath:e,uploadFileName:b[1].split("\b")[0],uploadCustomValue:"",uploadGroupId:b[1].split("\b")[1]}):self.postMessage({type:"complete",id:c,originalFileName:d,uploadFilePath:e,uploadFileName:b[1],uploadCustomValue:"",uploadGroupId:""}):3==
b.length&&(-1<b[2].indexOf("\b")?self.postMessage({type:"complete",id:c,originalFileName:d,uploadFilePath:e,uploadFileName:b[1],uploadCustomValue:b[2].split("\b")[0],uploadGroupId:b[2].split("\b")[1]}):self.postMessage({type:"complete",id:c,originalFileName:d,uploadFilePath:e,uploadFileName:b[1],uploadCustomValue:b[2],uploadGroupId:""}));XHRFactory.release(k)}}else if(400<=k.status&&600>k.status||0==k.status)d=k.responseText,b=d.split("|"),1==b.length&&(b=Dext5Base64.makeDecryptReponseMessageEx2(d),
d="success"==b.result?b.value:"error"==b.result?b.value:""==g.ServerReleaseVer||"2.7.1120889.1613.01">=g.ServerReleaseVer?Dext5Base64.decode(d):Dext5Base64.makeDecryptReponseMessage(d),b=d.split("|")),2==b.length?self.postMessage({type:"error",code:b[0],message:"Upload Error: "+b[1],id:c}):3==b.length?self.postMessage({type:"error",code:b[1],message:"Upload Error: "+b[2],id:c}):self.postMessage({type:"error",code:"000",message:"Upload Error: upload_merge",id:c}),XHRFactory.release(k),self.close()};
"0"!=g.encryptParam?(e=""+("d01"+Dext5Base64._trans_unitAttributeDelimiter+"mergeRequest"+Dext5Base64._trans_unitDelimiter),e+="d08"+Dext5Base64._trans_unitAttributeDelimiter+h+Dext5Base64._trans_unitDelimiter,e+="d07"+Dext5Base64._trans_unitAttributeDelimiter+f+Dext5Base64._trans_unitDelimiter,e+="d19"+Dext5Base64._trans_unitAttributeDelimiter+d.numberOfChunks+Dext5Base64._trans_unitDelimiter,e+="d12"+Dext5Base64._trans_unitAttributeDelimiter+q+Dext5Base64._trans_unitDelimiter,e+="d38"+Dext5Base64._trans_unitAttributeDelimiter+
t+Dext5Base64._trans_unitDelimiter,e+="d11"+Dext5Base64._trans_unitAttributeDelimiter+g.folderNameRule+Dext5Base64._trans_unitDelimiter,e+="d09"+Dext5Base64._trans_unitAttributeDelimiter+g.fileNameRule+Dext5Base64._trans_unitDelimiter,e+="d10"+Dext5Base64._trans_unitAttributeDelimiter+g.fileNameRuleEx+Dext5Base64._trans_unitDelimiter,f=Dext5Base64.makeEncryptParamFinal(g.encryptParam,e),f=f.name+"="+f.value):(f="dext5CMD=mergeRequest&fileName="+encodeURIComponent(h)+"&GUID="+f+"&numberOfChunks="+
d.numberOfChunks+"&gpid="+q+"&fidx="+t,f+="&folderNameRule="+g.folderNameRule+"&fileNameRule="+g.fileNameRule+"&fileNameRuleEx="+g.fileNameRuleEx,0<g.encryptFile&&(f+="&fde="+g.encryptFile));"1"==g.integrity&&(f+="&fdi="+g.FDIData);f+="&mark="+l;l=r.length;for(d=0;d<l;d++)f+="&"+r[d].form_name+"="+encodeURIComponent(r[d].form_value);k.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8");try{k.send(f)}catch(n){self.postMessage({type:"error",code:"000",message:"Upload Error: upload_merge",
id:c}),XHRFactory.release(k),self.close()}}
function upload(c,h,f,d,e,m,g,l,q,t,r,k){var n=XHRFactory.getInstance(),b=f,b=-1<b.indexOf("?")?b+"&dext=slice":b+"?dext=slice",b=b+("&p="+makeGuidTagName("urk_"));n.open("POST",b,e);var u=c.size;n.onreadystatechange=function(){if(4==n.readyState)if(200==n.status){var a=n.responseText,b=a.split("|");1==b.length&&(b=Dext5Base64.makeDecryptReponseMessageEx2(a),a="success"==b.result?b.value:"error"==b.result?b.value:""==l.ServerReleaseVer||"2.7.1120889.1613.01">=l.ServerReleaseVer?Dext5Base64.decode(a):
Dext5Base64.makeDecryptReponseMessage(a),b=a.split("|"));0==a.indexOf("error")?(self.postMessage({type:"error",code:b[1],message:b[2],id:m}),XHRFactory.release(n),self.close()):""!=n.responseText.replace(/ /g,"")?(self.postMessage({type:"error",code:"200018",message:"",id:m}),XHRFactory.release(n),self.close()):(numberOfServerUploadedChunks++,self.postMessage({type:"progress",uploadedChunks:numberOfServerUploadedChunks,uploadedSize:u,chunkInfo:d,id:m}),numberOfServerUploadedChunks==d.numberOfChunks&&
(upload_merge(m,h,g,d,f,e,l,q,t,r,k),numberOfServerUploadedChunks=0),XHRFactory.release(n))}else if(400<=n.status&&600>n.status||0==n.status)a=n.responseText,b=a.split("|"),1==b.length&&(b=Dext5Base64.makeDecryptReponseMessageEx2(a),a="success"==b.result?b.value:"error"==b.result?b.value:""==l.ServerReleaseVer||"2.7.1120889.1613.01">=l.ServerReleaseVer?Dext5Base64.decode(a):Dext5Base64.makeDecryptReponseMessage(a),b=a.split("|")),2==b.length?self.postMessage({type:"error",code:b[0],message:"Upload Error: "+
b[1],id:m}):3==b.length?self.postMessage({type:"error",code:b[1],message:"Upload Error: "+b[2],id:m}):self.postMessage({type:"error",code:"000",message:"Upload Error: upload_merge",id:m}),XHRFactory.release(n),self.close()};var p="",w=function(){try{n.send(p)}catch(a){self.postMessage({type:"reupload",chunk:c,filename:h,chunkInfo:d,asyncstate:e,guid:g,configValues:l,id:m,mark:q,gpid:t,fidx:r}),XHRFactory.release(n)}p=c=null};if("undefined"==typeof FormData){var a=makeGuidTagName("----dext5_"),b=function(b){p=
b;n.setRequestHeader("Content-Type","multipart/form-data; boundary="+a);n.setRequestHeader("Dext5-Encoded","base64");w()};try{buildFormData(c,d.currentNumber,g,h,l,a,d.size,q,t,r,k,b)}catch(x){self.postMessage({type:"reupload",chunk:c,filename:h,chunkInfo:d,asyncstate:e,guid:g,configValues:l,id:m,mark:q,gpid:t,fidx:r})}}else{p=new FormData;"0"!=l.encryptParam?(b=""+("d01"+Dext5Base64._trans_unitAttributeDelimiter+"uploadRequest"+Dext5Base64._trans_unitDelimiter),b+="d18"+Dext5Base64._trans_unitAttributeDelimiter+
d.currentNumber+Dext5Base64._trans_unitDelimiter,b+="d07"+Dext5Base64._trans_unitAttributeDelimiter+g+Dext5Base64._trans_unitDelimiter,b+="d08"+Dext5Base64._trans_unitAttributeDelimiter+h+Dext5Base64._trans_unitDelimiter,b+="d12"+Dext5Base64._trans_unitAttributeDelimiter+t+Dext5Base64._trans_unitDelimiter,b+="d38"+Dext5Base64._trans_unitAttributeDelimiter+r+Dext5Base64._trans_unitDelimiter,b+="d11"+Dext5Base64._trans_unitAttributeDelimiter+l.folderNameRule+Dext5Base64._trans_unitDelimiter,b+="d09"+
Dext5Base64._trans_unitAttributeDelimiter+l.fileNameRule+Dext5Base64._trans_unitDelimiter,b+="d10"+Dext5Base64._trans_unitAttributeDelimiter+l.fileNameRuleEx+Dext5Base64._trans_unitDelimiter,b+="d35"+Dext5Base64._trans_unitAttributeDelimiter+l.checkFileExtension+Dext5Base64._trans_unitDelimiter,b+="d37"+Dext5Base64._trans_unitAttributeDelimiter+l.uploadChunkSize+Dext5Base64._trans_unitDelimiter,b+="d47"+Dext5Base64._trans_unitAttributeDelimiter+d.size+Dext5Base64._trans_unitDelimiter,0<l.encryptFile&&
(b+="d17"+Dext5Base64._trans_unitAttributeDelimiter+l.encryptFile+Dext5Base64._trans_unitDelimiter),b=Dext5Base64.makeEncryptParamFinal(l.encryptParam,b),p.append(b.name,b.value)):(p.append("dext5CMD","uploadRequest"),p.append("chunkNumber",d.currentNumber),p.append("GUID",g),p.append("fileName",h),p.append("gpid",t),p.append("fidx",r),p.append("folderNameRule",l.folderNameRule),p.append("fileNameRule",l.fileNameRule),p.append("fileNameRuleEx",l.fileNameRuleEx),p.append("cfe",l.checkFileExtension),
p.append("cs",l.uploadChunkSize),p.append("fs",d.size),0<l.encryptFile&&p.append("fde",l.encryptFile));p.append("mark",q);for(var b=k.length,v=0;v<b;v++)p.append(k[v].form_name,encodeURIComponent(k[v].form_value));b=function(a){p.append("Slice",a);w()};0<l.encryptFile?(v=new FileReaderSync,v=v.readAsArrayBuffer(c),encryptFileData(v,l.ServerReleaseVer.substring(0,11),16*l.encryptFile,b),v=null):(p.append("Slice",c),w())}}
function uploadZeroFile(c,h,f,d,e,m,g,l,q,t,r){var k=XHRFactory.getInstance();k.open("POST",d,e);k.onreadystatechange=function(b){if(4==k.readyState)if(200==k.status){var d=k.responseText;b=d.split("|");1==b.length&&(b=Dext5Base64.makeDecryptReponseMessageEx2(d),d="success"==b.result?b.value:"error"==b.result?b.value:""==g.ServerReleaseVer||"2.7.1120889.1613.01">=g.ServerReleaseVer?Dext5Base64.decode(d):Dext5Base64.makeDecryptReponseMessage(d),b=d.split("|"));if(0==d.indexOf("error"))self.postMessage({type:"error",
code:b[1],message:b[2],id:c}),XHRFactory.release(k),self.close();else{var e;e=b[0];var f=e.indexOf("::");-1<f?(d=e.substring(0,f),e=e.substring(f+2)):(d=h,e=b[0]);2==b.length?-1<b[1].indexOf("\b")?self.postMessage({type:"complete",id:c,originalFileName:d,uploadFilePath:e,uploadFileName:b[1].split("\b")[0],uploadCustomValue:"",uploadGroupId:b[1].split("\b")[1]}):self.postMessage({type:"complete",id:c,originalFileName:d,uploadFilePath:e,uploadFileName:b[1],uploadCustomValue:"",uploadGroupId:""}):3==
b.length&&(-1<b[2].indexOf("\b")?self.postMessage({type:"complete",id:c,originalFileName:d,uploadFilePath:e,uploadFileName:b[1],uploadCustomValue:b[2].split("\b")[0],uploadGroupId:b[2].split("\b")[1]}):self.postMessage({type:"complete",id:c,originalFileName:d,uploadFilePath:e,uploadFileName:b[1],uploadCustomValue:b[2],uploadGroupId:""}));XHRFactory.release(k)}}else if(400<=k.status&&600>k.status||0==k.status)d=k.responseText,b=d.split("|"),1==b.length&&(b=Dext5Base64.makeDecryptReponseMessageEx2(d),
d="success"==b.result?b.value:"error"==b.result?b.value:""==g.ServerReleaseVer||"2.7.1120889.1613.01">=g.ServerReleaseVer?Dext5Base64.decode(d):Dext5Base64.makeDecryptReponseMessage(d),b=d.split("|")),2==b.length?self.postMessage({type:"error",code:b[0],message:"Upload Error: "+b[1],id:c}):3==b.length?self.postMessage({type:"error",code:b[1],message:"Upload Error: "+b[2],id:c}):self.postMessage({type:"error",code:"000",message:"Upload Error: uploadZeroFile",id:c}),XHRFactory.release(k),self.close()};
"0"!=g.encryptParam?(d=""+("d01"+Dext5Base64._trans_unitAttributeDelimiter+"uzr"+Dext5Base64._trans_unitDelimiter),d+="d08"+Dext5Base64._trans_unitAttributeDelimiter+h+Dext5Base64._trans_unitDelimiter,d+="d07"+Dext5Base64._trans_unitAttributeDelimiter+f+Dext5Base64._trans_unitDelimiter,d+="d12"+Dext5Base64._trans_unitAttributeDelimiter+q+Dext5Base64._trans_unitDelimiter,d+="d38"+Dext5Base64._trans_unitAttributeDelimiter+t+Dext5Base64._trans_unitDelimiter,d+="d11"+Dext5Base64._trans_unitAttributeDelimiter+
g.folderNameRule+Dext5Base64._trans_unitDelimiter,d+="d09"+Dext5Base64._trans_unitAttributeDelimiter+g.fileNameRule+Dext5Base64._trans_unitDelimiter,d+="d10"+Dext5Base64._trans_unitAttributeDelimiter+g.fileNameRuleEx+Dext5Base64._trans_unitDelimiter,d+="d35"+Dext5Base64._trans_unitAttributeDelimiter+g.checkFileExtension+Dext5Base64._trans_unitDelimiter,f=Dext5Base64.makeEncryptParamFinal(g.encryptParam,d),f=f.name+"="+f.value):(f="dext5CMD=uzr&fileName="+encodeURIComponent(h)+"&GUID="+f+"&gpid="+
q+"&fidx="+t,f+="&folderNameRule="+g.folderNameRule+"&fileNameRule="+g.fileNameRule+"&fileNameRuleEx="+g.fileNameRuleEx,f+="&cfe="+g.checkFileExtension);f+="&mark="+l;l=r.length;for(q=0;q<l;q++)f+="&"+r[q].form_name+"="+encodeURIComponent(r[q].form_value);k.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8");try{k.send(f)}catch(n){self.postMessage({type:"error",code:"000",message:"Upload Error: uploadZeroFile",id:c}),XHRFactory.release(k),XHRFactory=null,self.close()}}
self.onmessage=function(c){c=c.data;switch(c.type){case "upload":upload(c.chunk,c.filename,c.handlerurl,c.chunkInfo,c.asyncstate,c.id,c.guid,c.configValues,c.mark,c.gpid,c.fidx,c.formDataEx);break;case "uploadZeroFile":self.postMessage({type:"progress",uploadedChunks:1,uploadedSize:0,chunkInfo:{currentNumber:1,numberOfChunks:1,size:0},id:c.id}),uploadZeroFile(c.id,c.filename,c.guid,c.handlerurl,c.asyncstate,c.blob,c.configValues,c.mark,c.gpid,c.fidx,c.formDataEx)}};
function encryptFileData(c,h,f,d){var e=crypto||msCrypto;if(e&&e.subtle){var m=stringToBytes(h);h=new Uint8Array(f);h.set(m);var g=e.subtle.importKey("raw",h,{name:"AES-CBC"},!1,["encrypt","decrypt"]);g.then(function(f){var g=new Uint8Array(16);g.set(m);e.subtle.encrypt({name:"AES-CBC",iv:g},f,c).then(function(c){c=makeBlob(c);d(c)})["catch"]=function(c){self.postMessage({type:"error",code:"C011",message:c.message||c,workerId:workerData.workerId})}})["catch"]=function(c){self.postMessage({type:"error",
code:"C011",message:c.message||c,workerId:workerData.workerId})}}else g=CryptoJS.enc.Utf8.parse(h),g.sigBytes=f,wordArrayData=function(c){c=new Uint8Array(c);for(var d=[],e=0;e<c.length;e+=4)d.push(c[e]<<24|c[e+1]<<16|c[e+2]<<8|c[e+3]);return CryptoJS.lib.WordArray.create(d,c.length)}(c),h=CryptoJS.AES.encrypt(wordArrayData,g,{iv:CryptoJS.enc.Utf8.parse(h)}),wordArrayData=void 0,h=makeBlob(function(c){var d=c.words.length,e=new Uint8Array(d<<2),f=0,g,h;for(h=0;h<d;h++)g=c.words[h],e[f++]=g>>24,e[f++]=
g>>16&255,e[f++]=g>>8&255,e[f++]=g&255;return e}(h.ciphertext)),d(h)}function arrayBufferToBase64(c){var h="";c=new Uint8Array(c);for(var f=c.byteLength,d=0;d<f;d++)h+=String.fromCharCode(c[d]);return btoa(h)}function stringToBytes(c){for(var h,f,d=[],e=0;e<c.length;e++){h=c.charCodeAt(e);f=[];do f.push(h&255),h>>=8;while(h);d=d.concat(f.reverse())}return d}var makeBlob=function(c){var h=[];h.push(c);return new Blob(h,{type:"application/octet-stream"})};
