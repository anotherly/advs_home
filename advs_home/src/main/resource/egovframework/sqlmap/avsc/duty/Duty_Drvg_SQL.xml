<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="driving">

	<typeAlias  alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>

	<!-- 목록 조회 -->
	<select id="drvgDAO.selectDrvgList" parameterClass="java.util.HashMap" resultClass="egovMap">
		/*drvgDAO.selectDrvgList*/
		SELECT *
		  FROM (
		        SELECT A.*
		              ,DATE_FORMAT(A.STND_DT, '%Y-%m-%d') AS STND_DT_VIEW
		              ,DATE_FORMAT(A.STND_DT, '%Y%m%d%H%i%s') AS STND_DT_KEY
		              ,DATE_FORMAT(A.REG_DATE, '%Y-%m-%d %H:%i') AS REG_DATE_VIEW
		              ,ROUND(DATEDIFF(A.REG_DATE, A.STND_DT)-1, 1) AS COLDIFF
		              ,CEIL( ROW_NUMBER() OVER (ORDER BY A.REG_DATE ASC) ) LISTCNT
		              ,CEIL( ROW_NUMBER() OVER (ORDER BY A.REG_DATE DESC) / 10 ) PAGECNT
		          FROM TB_CL_HT_DRIVING A
		              ,( SELECT E.TMP_RACE_NUMBER 
		                   FROM TB_CM_HT_TEMPOPER E
		                  WHERE 1=1
							   <isNotEqual prepend="AND" property="authid" compareValue="103">
					         E.USER_ID = #userid#
							   </isNotEqual>
		                    AND E.APPOR_STATUS = '102'
		               ) B
		         WHERE 1=1
		           AND A.TMP_RACE_NUMBER = B.TMP_RACE_NUMBER
				   <isEqual prepend="AND" property="searchType" compareValue="1">
				      A.TMP_RACE_AGENCY LIKE Concat('%' , #searchWord# , '%')
				   </isEqual>
				   <isEqual prepend="AND" property="searchType" compareValue="2">
				      A.TMP_RACE_NUMBER LIKE Concat('%' , #searchWord# , '%')
				   </isEqual>
				   <isEqual prepend="AND" property="searchType" compareValue="3">
				      A.STND_DT LIKE Concat('%' , #searchWord# , '%')
				   </isEqual>
		       )AB
		 WHERE PAGECNT = #iPageNo#
		 ORDER BY AB.REG_DATE DESC
	</select>
	
	<!-- 총 갯수 -->
	<select id="drvgDAO.selectDrvgListTotCnt" parameterClass="java.util.HashMap" resultClass="int">
		/*drvgDAO.selectDrvgListTotCnt*/
		SELECT COUNT(*) totcnt
		FROM TB_CL_HT_DRIVING A
		      ,( SELECT E.TMP_RACE_NUMBER 
		           FROM TB_CM_HT_TEMPOPER E
		          WHERE 1=1
					 <isNotEqual prepend="AND" property="authid" compareValue="103">
			         E.USER_ID = #userid#
					 </isNotEqual>
		            AND E.APPOR_STATUS = '102'
		       ) B
		WHERE 1=1
		AND A.TMP_RACE_NUMBER = B.TMP_RACE_NUMBER
	    <isEqual prepend="AND" property="searchType" compareValue="1">
<!-- 	        A.TMP_RACE_AGENCY LIKE '%' || #searchWord# || '%' -->
	        A.TMP_RACE_AGENCY LIKE Concat('%' , #searchWord# , '%')
	    </isEqual>
	    <isEqual prepend="AND" property="searchType" compareValue="2">
<!-- 	        A.TMP_RACE_NUMBER LIKE '%' || #searchWord# || '%' -->
	        A.TMP_RACE_NUMBER LIKE Concat('%' , #searchWord# , '%')
	   </isEqual>
	   <isEqual prepend="AND" property="searchType" compareValue="3">
	      A.STND_DT LIKE Concat('%' , #searchWord# , '%')
	   </isEqual>
	</select>

	<!-- 중복확인 -->
	<select id="drvgDAO.selectDrvgIsExist" parameterClass="java.util.HashMap" resultClass="int">
		/*drvgDAO.selectDrvgIsExist*/
		SELECT COUNT(*) selcnt
		FROM TB_CL_HT_DRIVING A
		WHERE 1=1
		AND A.TMP_RACE_NUMBER = #drv_no#
		AND A.STND_DT = DATE_FORMAT(#std_dt#,'%Y%m%d%H%i%s')
	</select>

	<!-- 상세내용 -->
	<select id="drvgDAO.selectDrvgInfo" parameterClass="java.util.HashMap" resultClass="egovMap">
		/*drvgDAO.selectDrvgInfo*/
		SELECT A.*
		      ,DATE_FORMAT(A.INS_INIT_DATE,'%Y-%m-%d') AS INS_INIT_DATE_VIEW
			  ,DATE_FORMAT(A.STND_DT,'%Y-%m-%d') AS STND_DT_VIEW
		      ,DATE_FORMAT(A.STND_DT,'%Y%m%d%H%i%s') AS STND_DT_KEY
		FROM TB_CL_HT_DRIVING A
		WHERE 1=1
		AND A.TMP_RACE_NUMBER = #drv_no#
		AND A.STND_DT = DATE_FORMAT(#std_dt#,'%Y-%m-%d %H:%i:%s')
	</select>

	<!-- 자율주행 목록 조회 -->
	<select id="drvgDAO.selectAutoDrivingList" parameterClass="java.util.HashMap" resultClass="egovMap">
		/*drvgDAO.selectAutoDrivingList*/
		SELECT A.*
			  ,DATE_FORMAT(STR_TO_DATE(A.DRIVING_DIST_MON,'%Y%m'),'%Y-%m') AS DRIVING_DIST_MON_VIEW
		FROM TB_CL_HT_AUTODRIVING A				
		WHERE 1=1
		AND A.TMP_RACE_NUMBER = #drv_no#
		AND A.STND_DT = DATE_FORMAT(#std_dt#,'%Y-%m-%d %H:%i:%s')
		ORDER BY A.DRIVING_DIST_MON
	</select>

	<!-- 제어권전환 목록 조회 -->
	<select id="drvgDAO.selectCtrChangeList" parameterClass="java.util.HashMap" resultClass="egovMap">
		/*drvgDAO.selectCtrChangeList*/
		SELECT A.*
			   ,DATE_FORMAT(STR_TO_DATE(A.CTR_CHANGE_MON,'%Y%m'),'%Y-%m') AS CTR_CHANGE_MON_VIEW
		FROM TB_CL_HT_CTRCHANGE  A
		WHERE 1=1
		AND A.TMP_RACE_NUMBER = #drv_no#
		AND A.STND_DT = DATE_FORMAT(#std_dt#,'%Y-%m-%d %H:%i:%s')
		ORDER BY A.CTR_CHANGE_MON
	</select>

	<!-- 제어권전환 상세 목록 조회 -->
	<select id="drvgDAO.selectCtrChangeDtlList" parameterClass="java.util.HashMap" resultClass="egovMap">
		/*drvgDAO.selectCtrChangeDtlList*/
		SELECT
				CCD.TMP_RACE_NUMBER AS TMP_RACE_NUMBER,
				CCD.CTR_CHANGE_DATE AS CTR_CHANGE_DATE,
				CCD.STND_DT AS STND_DT,
				CCD.CTR_CHANGE_PLACE AS CTR_CHANGE_PLACE,		
				CASE WHEN CCD.CTR_CHANGE_CONTENT IS NULL THEN CCD.CTR_CHANGE_CONTENT_BEFORE 
					  ELSE (SELECT CTR_CHANGE_NM FROM TB_CL_HT_CTRCHANGE_CODE CHCC WHERE CHCC.CTR_CHANGE_NM = CCD.CTR_CHANGE_CONTENT) END AS CTR_CHANGE_CONTENT,
				CCD.RMK, 
				DATE_FORMAT(CCD.CTR_CHANGE_DATE,'%Y-%m-%d %H:%i:%s') AS CTR_CHANGE_DATE_VIEW
		  FROM TB_CL_HT_CTRCHANGEDETAIL CCD
		 WHERE 1=1
				AND CCD.TMP_RACE_NUMBER = #drv_no#
				AND CCD.STND_DT = DATE_FORMAT(#std_dt#,'%Y-%m-%d %H:%i:%s')
				ORDER BY CCD.CTR_CHANGE_DATE
	</select>

	<!-- 운행정보 등록 -->
	<insert id="drvgDAO.insertDrvg" parameterClass="java.util.HashMap">
		/*drvgDAO.insertDrvg*/
		INSERT 
		INTO TB_CL_HT_DRIVING 
		       (TMP_RACE_NUMBER
		       ,STND_DT
		       ,TMP_RACE_AGENCY
		       ,INS_LETTER_NUMBER
		       ,INS_INIT_DATE
		       ,TOTAL_DRIVING_DIST
		       ,AUTO_DRIVING_DIST
		       ,NOMAL_DRIVING_DIST
		       ,REG_ID
		       ,REG_DATE)
		VALUES (#tmp_race_number#
		       ,DATE_FORMAT(#stnd_dt#,'%Y-%m-%d')
		       ,#tmp_race_agency#
		       ,'-'
		       <!-- ,DATE_FORMAT(#ins_init_date#,'%Y-%m-%d %H:%i:%s') -->
		       ,#ins_init_date#
		       ,#total_driving_dist#
		       ,#auto_driving_dist#
		       ,#nomal_driving_dist#
		       ,#reg_id#
		       ,SYSDATE()) 
	</insert>

	<!-- 수정 -->
	<update id="drvgDAO.updateDrvg" parameterClass="java.util.HashMap">
		/*drvgDAO.updateDrvg*/
        UPDATE TB_CL_HT_DRIVING
        	SET TOTAL_DRIVING_DIST		= #total_driving_dist#
		    	,AUTO_DRIVING_DIST		= #auto_driving_dist#
		        ,NOMAL_DRIVING_DIST		= #nomal_driving_dist#
		      	,UPDATE_ID				= #reg_id#
		      	,UPDATE_DATE			= SYSDATE()
		      	,INS_INIT_DATE 			= #ins_init_date#
		WHERE 1=1
		AND TMP_RACE_NUMBER = #drv_no#
		AND STND_DT = DATE_FORMAT(#std_dt#,'%Y-%m-%d')
	</update>
	
	<!-- 삭제 -->
	<delete id="drvgDAO.deleteDrvg" parameterClass="java.util.HashMap">
		/*drvgDAO.deleteDrvg*/
		DELETE FROM TB_CL_HT_DRIVING
		WHERE 1=1
		AND TMP_RACE_NUMBER = #drv_no#
		AND STND_DT = DATE_FORMAT(#std_dt#,'%Y-%m-%d')
	</delete>

	<!-- 자율주행 등록 -->
	<insert id="drvgDAO.insertAutoDriving" parameterClass="java.util.HashMap">
		/*drvgDAO.insertAutoDriving*/
		INSERT 
		INTO TB_CL_HT_AUTODRIVING 
		       (TMP_RACE_NUMBER
		       ,DRIVING_DIST_MON
		       ,STND_DT
		       ,AUTO_DRIVING_DIST
		       ,REG_ID
		       ,REG_DATE)
		VALUES (#tmp_race_number#
		       ,#driving_dist_mon#
		       ,DATE_FORMAT(#stnd_dt#,'%Y-%m-%d')
		       ,#auto_driving_dist#
		       ,#reg_id#
		       ,SYSDATE())
	</insert>

	<!-- 자율주행 수정 -->
	<update id="drvgDAO.updateAutoDriving" parameterClass="java.util.HashMap">
		/*drvgDAO.updateAutoDriving*/
        UPDATE TB_CL_HT_AUTODRIVING
        	SET AUTO_DRIVING_DIST		= #auto_driving_dist#
		      ,UPDATE_ID				= #reg_id#
		      ,UPDATE_DATE				= SYSDATE()
		WHERE 1=1
		AND TMP_RACE_NUMBER = #drv_no#
		AND STND_DT = DATE_FORMAT(#std_dt#,'%Y-%m-%d')
		AND DRIVING_DIST_MON = #driving_dist_mon#
	</update>
	
	<!-- 자율주행 삭제 -->
	<delete id="drvgDAO.deleteAutoDriving" parameterClass="java.util.HashMap">
		/*drvgDAO.deleteAutoDriving*/
		DELETE FROM TB_CL_HT_AUTODRIVING
		WHERE 1=1
		AND TMP_RACE_NUMBER = #drv_no#
		AND STND_DT = DATE_FORMAT(#std_dt#,'%Y-%m-%d')
	</delete>

	<!-- 제어권전환 등록 -->
	<insert id="drvgDAO.insertCtrChange" parameterClass="java.util.HashMap">
		/*drvgDAO.insertCtrChange*/
		INSERT 
		INTO TB_CL_HT_CTRCHANGE
		       (TMP_RACE_NUMBER
		       ,CTR_CHANGE_MON
		       ,STND_DT
		       ,CTR_CHANGE_CNT
		       ,REG_ID
		       ,REG_DATE)
		VALUES (#tmp_race_number#
		       ,#ctr_change_mon#
		       ,DATE_FORMAT(#stnd_dt#, '%Y-%m-%d')
		       ,#ctr_change_cnt#
		       ,#reg_id#
		       ,SYSDATE())
	</insert>

	<!-- 제어권전환 수정 -->
	<update id="drvgDAO.updateCtrChange" parameterClass="java.util.HashMap">
		/*drvgDAO.updateCtrChange*/
        UPDATE TB_CL_HT_CTRCHANGE
           SET CTR_CHANGE_CNT		= #ctr_change_cnt#
		      ,UPDATE_ID			= #reg_id#
		      ,UPDATE_DATE			= SYSDATE()
		 WHERE 1=1
		 AND TMP_RACE_NUMBER = #drv_no#
		 AND STND_DT = DATE_FORMAT(#std_dt#,'%Y-%m-%d')
		 AND CTR_CHANGE_MON = #ctr_change_mon#
	</update>
	
	<!-- 제어권전환 삭제 -->
	<delete id="drvgDAO.deleteCtrChange" parameterClass="java.util.HashMap">
		/*drvgDAO.deleteCtrChange*/
		DELETE FROM TB_CL_HT_CTRCHANGE
     	WHERE 1=1
		AND TMP_RACE_NUMBER = #drv_no#
		AND STND_DT = DATE_FORMAT(#std_dt#,'%Y-%m-%d')
	</delete>

	<!-- 제어권전환 상세 등록 -->
	<insert id="drvgDAO.insertCtrChangeDtl" parameterClass="java.util.HashMap">
		/*drvgDAO.insertCtrChangeDtl*/
		INSERT 
		  INTO TB_CL_HT_CTRCHANGEDETAIL
		       (TMP_RACE_NUMBER
		       ,CTR_CHANGE_DATE
		       ,STND_DT
		       ,CTR_CHANGE_PLACE
		       ,CTR_CHANGE_CONTENT
		       ,RMK
		       ,REG_ID
		       ,REG_DATE)
		VALUES (#tmp_race_number#
		       , DATE_FORMAT(#ctr_change_date#,'%Y-%m-%d')
			   ,DATE_FORMAT(#stnd_dt#,'%Y-%m-%d')
		       ,#ctr_change_place#
		       ,#ctr_change_content#
		       ,#rmk#
		       ,#reg_id#
		       ,SYSDATE())
	</insert>

	<!-- 제어권전환 상세 삭제 -->
	<delete id="drvgDAO.deleteCtrChangeDtl" parameterClass="java.util.HashMap">
		/*drvgDAO.deleteCtrChangeDtl*/
		DELETE FROM TB_CL_HT_CTRCHANGEDETAIL
		WHERE 1=1
		AND TMP_RACE_NUMBER = #drv_no#
		AND STND_DT = DATE_FORMAT(#std_dt#,'%Y-%m-%d')
	</delete>

	<!-- 중복확인 -->
	<select id="drvgDAO.selectDrvgIsCheck" parameterClass="java.util.HashMap" resultClass="int">
		/*drvgDAO.selectDrvgIsCheck*/
		SELECT COUNT(*) selcnt
		FROM TB_CM_MT_PARAMETER
		WHERE 1=1
		AND PARAM_ID IN ('oper_input_sch_1','oper_input_sch_2')
		AND SYSDATE() BETWEEN STR_TO_DATE(CONCAT(DATE_FORMAT(SYSDATE(),'%Y'), DATA1, ' 00:00:00'), '%Y%m%d %H:%i:%s')
		AND STR_TO_DATE(CONCAT(DATE_FORMAT(SYSDATE(),'%Y'), DATA2, ' 23:59:59'), '%Y%m%d %H:%i:%s')
	</select>
	
	
	<!-- 제어권전환 상세 등록_엑셀 업로드 -->
	<insert id="drvgDAO.excelUpload" parameterClass="java.util.HashMap">
		/*QEURY ID : drvgDAO.excelUpload*/
		INSERT 
		  INTO TB_CL_HT_CTRCHANGEDETAIL
		       (
		       	TMP_RACE_NUMBER
		       ,CTR_CHANGE_DATE
		       ,STND_DT
		       ,CTR_CHANGE_PLACE
		       ,CTR_CHANGE_CONTENT
		       ,CTR_CHANGE_CONTENT_BEFORE
		       ,RMK
		       ,REG_ID
		       ,REG_DATE
		       )
		VALUES (
				#tmpRaceNumber#
		       ,STR_TO_DATE(#ctrChangeDate#, '%Y-%m-%d %H:%i:%s')
		       , DATE_FORMAT(#stndDt#, '%Y-%m-%d %H:%i:%s')
			   ,#ctrChangePlace#
		       ,#ctrChangeContent#
		       ,#ctrChangeContentBefore#
		       ,#rmk#
		       ,#reg_id#
		       ,SYSDATE()
				)
		ON DUPLICATE KEY UPDATE 
				CTR_CHANGE_PLACE = #ctrChangePlace#
		       ,CTR_CHANGE_CONTENT = #ctrChangeContent#
		       ,CTR_CHANGE_CONTENT_BEFORE = #ctrChangeContentBefore#
		       ,RMK = #rmk#
		       ,UPDATE_ID			= #reg_id#
		       ,UPDATE_DATE			= SYSDATE()
	</insert>
	<select id="drvgDAO.selectAttachFileList" parameterClass="java.util.HashMap" resultClass="egovMap">
		/* QUERY ID : drvgDAO.selectAttachFileList */
		SELECT A.*  FROM TB_WEB_HT_BLBD A
		WHERE BLBD_DIV_CD ='101'
			AND BDWR_SEQ = '6'
			AND GPBC_YN = 'N'
	</select>

</sqlMap>
