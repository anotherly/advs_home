<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="trend">

	<typeAlias  alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>

	<resultMap id="trendMap" class="java.util.HashMap">
		<result property="blbdDivCdView" column="BLBD_DIV_CD_VIEW" />
		<result property="blbdDivCd" column="BLBD_DIV_CD" />
		<result property="bdwrSeq" column="BDWR_SEQ" />
		<result property="bdwrDivCdView" column="BDWR_DIV_CD_VIEW" />
		<result property="bdwrTtlNm" column="BDWR_TTL_NM" />
		<result property="iqurNctnView" column="IQUR_NCTN_VIEW" />
		<result property="attachFilename" column="ATTACH_FILENAME" />
		<result property="fileSizeView" column="FILE_SIZE_VIEW" />
		<result property="gpbcYn" column="GPBC_YN" />
		<result property="bdwrRtngCdView" column="BDWR_RTNG_CD_VIEW" />
		<result property="bdwrCts" column="BDWR_CTS"		jdbcType="CLOB"		javaType="java.lang.String"/>
		<result property="bdwrRtngCdView" column="BDWR_RTNG_CD_VIEW" />
		<result property="fileSizeView" column="FILE_SIZE_VIEW" />
		<result property="userNm" column="USER_NM" />
		<result property="regDateView" column="REG_DATE_VIEW" />
		<result property="prevBdwrSeq" column="PREV_BDWR_SEQ" />
		<result property="prevBdwrTtlNm" column="PREV_BDWR_TTL_NM" />
		<result property="nextBdwrSeq" column="NEXT_BDWR_SEQ" />
		<result property="nextBdwrTtlNm" column="NEXT_BDWR_TTL_NM" />
		
		
		
		
	</resultMap>

	<!-- 목록 조회 -->
	<select id="trndDAO.selectTrndList" parameterClass="java.util.HashMap" resultClass="egovMap">
	/* QUERY ID : trndDAO.selectTrndList*/
		SELECT *
		  FROM (
		        SELECT A.*
		              ,IFNULL(IQUR_NCTN,0) AS IQUR_NCTN_VIEW 
		              ,fn_ct_get_code_name('blbd_div_cd', A.BLBD_DIV_CD ) AS BLBD_DIV_CD_VIEW
		              ,fn_ct_get_code_name('bdwr_div_cd', A.BDWR_DIV_CD ) AS BDWR_DIV_CD_VIEW
		              ,fn_ct_get_code_name('bdwr_rtng_cd', A.BDWR_RTNG_CD ) AS BDWR_RTNG_CD_VIEW
		              ,(SELECT USER_NM FROM TB_CM_IT_USER WHERE USER_ID = A.REG_ID) AS USER_NM
		              ,IFNULL(FORMAT(ROUND(IFNULL(A.FILE_SIZE,0)/1024,0), 0),'-') AS FILE_SIZE_VIEW
		              ,DATE_FORMAT(A.REG_DATE, '%Y-%m-%d') AS REG_DATE_VIEW
		              ,CEIL( ROW_NUMBER() OVER (ORDER BY A.REG_DATE DESC) / 10 ) LISTCNT
		          FROM TB_WEB_HT_BLBD A
		         WHERE 1=1
		           AND A.BLBD_DIV_CD = #blbd_div_cd#
		           AND A.GPBC_YN = 'Y'
					   <isEqual prepend="AND" property="searchType" compareValue="1">
					    A.BDWR_TTL_NM LIKE CONCAT('%' , #searchWord# , '%')
					   </isEqual>
					   <isEqual prepend="AND" property="searchType" compareValue="2">
					    A.BDWR_CTS LIKE CONCAT('%' , #searchWord# , '%')
					   </isEqual>
		         ORDER BY A.REG_DATE DESC
		       ) B
		 WHERE LISTCNT = #iPageNo#
	</select>
	
	<!-- 총 갯수 -->
	<select id="trndDAO.selectTrndListTotCnt" parameterClass="java.util.HashMap" resultClass="int">
		SELECT COUNT(*) totcnt
		  FROM TB_WEB_HT_BLBD A
		 WHERE 1=1
		   AND A.BLBD_DIV_CD = #blbd_div_cd#
		 <isEqual prepend="AND" property="searchType" compareValue="1">
		  A.BDWR_TTL_NM LIKE CONCAT('%' , #searchWord# , '%')
		 </isEqual>
		 <isEqual prepend="AND" property="searchType" compareValue="2">
		  A.BDWR_CTS LIKE CONCAT('%' , #searchWord# , '%')
		 </isEqual>
	</select>

	<!-- 상세내용 -->
	<select id="trndDAO.selectTrndInfo" parameterClass="java.util.HashMap" resultMap="trendMap">
		<![CDATA[
		SELECT A.*
          ,IFNULL(IQUR_NCTN,0) AS IQUR_NCTN_VIEW
		      ,A.BLBD_DIV_CD AS BLBD_DIV_CD
		      ,fn_ct_get_code_name('blbd_div_cd', A.BLBD_DIV_CD ) AS BLBD_DIV_CD_VIEW
		      ,fn_ct_get_code_name('bdwr_div_cd', A.BDWR_DIV_CD ) AS BDWR_DIV_CD_VIEW
		      ,fn_ct_get_code_name('bdwr_rtng_cd', A.BDWR_RTNG_CD ) AS BDWR_RTNG_CD_VIEW
		      ,(SELECT USER_NM FROM TB_CM_IT_USER WHERE USER_ID = A.REG_ID) AS USER_NM
		      ,IFNULL(FORMAT(ROUND(IFNULL(A.FILE_SIZE,0)/1024,0), 0),'-') AS FILE_SIZE_VIEW
		      ,DATE_FORMAT(A.REG_DATE, '%Y-%m-%d %H:%i') AS REG_DATE_VIEW
		      ,(SELECT MAX(B.BDWR_SEQ) FROM TB_WEB_HT_BLBD B WHERE B.BLBD_DIV_CD = #blbd_div_cd# AND B.BDWR_SEQ < #bdwr_seq#) AS PREV_BDWR_SEQ
		      ,(SELECT C.BDWR_TTL_NM FROM TB_WEB_HT_BLBD C WHERE C.BLBD_DIV_CD = #blbd_div_cd# AND C.BDWR_SEQ = (SELECT MAX(D.BDWR_SEQ) FROM TB_WEB_HT_BLBD D WHERE D.BLBD_DIV_CD = #blbd_div_cd# AND D.BDWR_SEQ < #bdwr_seq#)) AS PREV_BDWR_TTL_NM
		      ,(SELECT MIN(E.BDWR_SEQ) FROM TB_WEB_HT_BLBD E WHERE E.BLBD_DIV_CD = #blbd_div_cd# AND E.BDWR_SEQ > #bdwr_seq#) AS NEXT_BDWR_SEQ
		      ,(SELECT F.BDWR_TTL_NM FROM TB_WEB_HT_BLBD F WHERE F.BLBD_DIV_CD = #blbd_div_cd# AND F.BDWR_SEQ = (SELECT MIN(G.BDWR_SEQ) FROM TB_WEB_HT_BLBD G WHERE G.BLBD_DIV_CD = #blbd_div_cd# AND G.BDWR_SEQ > #bdwr_seq#)) AS NEXT_BDWR_TTL_NM
		  FROM TB_WEB_HT_BLBD A
		 WHERE 1=1
		   AND A.BLBD_DIV_CD	= #blbd_div_cd#
		   AND A.BDWR_SEQ 		= #bdwr_seq#
		]]>
	</select>

	<!-- 조회수 증가 -->
	<update id="trndDAO.updateIqurNctn" parameterClass="java.util.HashMap">
		UPDATE TB_WEB_HT_BLBD
		   SET IQUR_NCTN = IFNULL(IQUR_NCTN,0)+1
		 WHERE 1=1
		   AND BLBD_DIV_CD	= #blbd_div_cd#
		   AND BDWR_SEQ 	= #bdwr_seq#
	</update>

</sqlMap>
