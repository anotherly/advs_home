<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="rights">

	<typeAlias  alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>

	<!-- 중복확인 -->
	<select id="viseDAO.selectRightsIsExist" parameterClass="java.util.HashMap" resultClass="int">
		SELECT COUNT(*) selcnt
		  FROM TB_WEB_IT_USER A
		 WHERE 1=1
		   AND A.USER_ID = #user_id#
	</select>

	<!-- 정보 등록 -->
	<insert id="viseDAO.insertRights" parameterClass="java.util.HashMap">
		INSERT 
		  INTO TB_WEB_IT_USER 
		       (USER_ID
		       ,USER_NM
		       ,AUTH_CD
		       ,AGENCY_CD
		       ,CLASS_ID
		       ,RMK
		       ,USE_YN
		       ,CONN_ALLOWED_START_TIME
		       ,CONN_ALLOWED_END_TIME
		       ,IS_FIRST
		       ,APPOR_STATUS
		       ,CNCL_NOTE
		       ,REG_ID
		       ,REG_DATE)
		VALUES (#user_id#
		       ,#user_nm#
		       ,#auth_cd#
		       ,#agency_cd#
		       ,#class_id#
		       ,#rmk#
		       ,#use_yn#
		       ,NOW()
		       ,DATE_FORMAT('2030-12-31 23:59:59', '%Y-%m-%d %H:%m:%i')
		       ,'N'
		       ,#appor_status#
		       ,null
		       ,#user_id#
		       ,NOW())
	</insert>

	<!-- 유저정보 -->
	<select id="viseDAO.selectRightsInfo" parameterClass="java.util.HashMap" resultClass="egovMap">
		SELECT A.USER_ID
		      ,A.USER_NM
		      ,A.AUTH_CD
		      ,A.AGENCY_CD
		      ,fn_ct_get_agency_name(A.USER_ID) AGENCY_NM
		      ,A.CLASS_ID 
		  FROM TB_WEB_IT_USER A
		 WHERE 1=1
		   AND A.USE_YN = 'Y'
		   AND A.APPOR_STATUS = '102'
		   AND A.USER_ID = #user_id#
	</select>

	<!-- 임시 승인 조회 -->
	<select id="viseDAO.selectReqConfirmList" parameterClass="java.util.HashMap" resultClass="egovMap">
		WITH REQ_LIST AS (
		SELECT 'T' AS REQ_TP, '임시운행번호' AS REQ_TP_NM,
		       TMP_RACE_NUMBER AS REQ_ID, USER_ID, TO_CHAR(REG_DATE, 'YYYY-MM-DD HH24:MI') AS REG_DATE,
		       APPOR_STATUS AS STATUS_CD, fn_ct_get_code_name('appor_status', APPOR_STATUS) AS STATUS_NM,
		       '' AS AUTH_NM
		  FROM TB_CM_HT_TEMPOPER
		UNION ALL
		SELECT 'U' AS REQ_TP, '권한승인요청' AS REQ_TP_NM,
		       USER_ID AS REQ_ID, USER_ID, TO_CHAR(REG_DATE, 'YYYY-MM-DD HH24:MI') AS REG_DATE,
		       APPOR_STATUS AS STATUS_CD, fn_ct_get_code_name('appor_status', APPOR_STATUS) AS STATUS_NM,
           fn_ct_get_code_name('auth_cd', AUTH_CD) AS AUTH_NM
		  FROM TB_WEB_IT_USER
		)
		SELECT REQ_TP, REQ_TP_NM, REQ_ID, USER_ID, REG_DATE, STATUS_CD, STATUS_NM, AUTH_NM
		  FROM REQ_LIST
		 WHERE STATUS_CD = '101'
		<isNotEmpty prepend="AND" property="sReqType">  
		 	REQ_TP = #sReqType#
		</isNotEmpty> 
		 ORDER BY REG_DATE DESC
	</select>

	<!-- 임시 승인 번호 -->
	<update id="viseDAO.updateReqConfirm_T" parameterClass="java.util.HashMap">
	<![CDATA[
          UPDATE TB_CM_HT_TEMPOPER
             SET APPOR_STATUS  	= #apporStatus#,
                 CNCL_NOTE     	= #cnclNote#   
           WHERE TMP_RACE_NUMBER = #reqId#
    ]]>
	</update>
	
	<!-- 임시승인 유저 -->
	<update id="viseDAO.updateReqConfirm_U" parameterClass="java.util.HashMap">
	<![CDATA[
          UPDATE TB_WEB_IT_USER
             SET APPOR_STATUS  	= #apporStatus#,
                 USE_YN     	  = 'Y',
                 CNCL_NOTE     	= #cnclNote#
           WHERE USER_ID = #reqId#
    ]]>
	</update>
	
	<!-- 문의 및 연락처 조회 -->
	<select id="viseDAO.selectContectInfo" resultClass="java.util.HashMap" >
		/*viseDAO.selectContectInfo*/
		SELECT TITLE AS title,
			   CONTENT AS content,
			   TEL_NO AS telNo,
			   FAX_NO AS faxNo,
			   EMAIL AS email,
			   REG_DATE AS regDate
		FROM TB_CONTECT
		WHERE 1=1
		ORDER BY REG_DATE DESC
		LIMIT 1
	</select>

</sqlMap>
